---
title: "R Notebook"
output:rmarkdown::github_document
  pdf_document: default
  word_document: default
  html_notebook: default
---



```{r}
library(survival)
library(tidyverse)
dat <- pbc
head(dat)
```

```{r}
summary(dat$time / 365.25)

```


```{r}
hist(dat$age)
summary(dat$age)
```

## 
```{r}
table(dat$sex)
```

## distribution of the time to death in years
```{r}
hist(dat$time/365.25)
summary(dat$time)
```


```{r}
table(dat$status)
```



## data preparation and identifying the cesoring variable
```{r}
dat$newStatus <- ifelse(dat$status != 2, dat$newStatus <- 0, dat$newStatus <- 1)
dat$trt <- ifelse(!is.na(dat$trt), dat$trt <- dat$trt, dat$trt <- 3)
head(dat$status)
head(dat$newStatus)
dat$group <- ifelse(dat$trt == 1, dat$group <- 'D-penicillmain', ifelse(dat$trt == 2, dat$group <- 'placebo', dat$group <- 'not-randomised'))
dat$chol = ifelse(is.na(dat$chol),
                  ave(dat$chol, FUN = function(x) mean(x, na.rm = TRUE)),
                  dat$chol)
dat$albumin = ifelse(is.na(dat$albumin),
                  ave(dat$albumin, FUN = function(x) mean(x, na.rm = TRUE)),
                  dat$albumin)
dat$copper = ifelse(is.na(dat$copper),
                  ave(dat$copper, FUN = function(x) mean(x, na.rm = TRUE)),
                  dat$copper)
dat$alk.phos = ifelse(is.na(dat$alk.phos),
                  ave(dat$alk.phos, FUN = function(x) mean(x, na.rm = TRUE)),
                  dat$alk.phos)
dat$ast = ifelse(is.na(dat$ast),
                  ave(dat$ast, FUN = function(x) mean(x, na.rm = TRUE)),
                  dat$ast)
dat$trig = ifelse(is.na(dat$trig),
                  ave(dat$trig, FUN = function(x) mean(x, na.rm = TRUE)),
                  dat$trig)
dat$platelet = ifelse(is.na(dat$platelet),
                  ave(dat$platelet, FUN = function(x) mean(x, na.rm = TRUE)),
                  dat$platelet)
dat$protime = ifelse(is.na(dat$protime),
                  ave(dat$protime, FUN = function(x) mean(x, na.rm = TRUE)),
                  dat$protime)
dat$ascites = ifelse(!is.na(dat$ascites), dat$ascites, dat$ascites <- 0)
dat$hepato = ifelse(!is.na(dat$hepato), dat$hepato, dat$hepato <- 1)
dat$spiders = ifelse(!is.na(dat$spiders), dat$spiders, dat$spiders <- 0)
dat$stage = ifelse(!is.na(dat$stage), dat$stage, dat$stage <- 2)

```
## proportion of newStatus variable
```{r}
table(dat$newStatus)
```


```{r}
table(dat$group)
```


```{r}
table(dat$newStatus)
```


## Kaplan Meyer Estimator
```{r}
dat <- mutate(dat, timeYears = time / 365.25)
fit.KM <- survfit(Surv(timeYears, newStatus) ~ 1, data = dat, conf.type = "log-log")
summary(fit.KM)
plot(fit.KM,
     main = "Kaplan-Meier estimator",
     ylab = "Survival probability",
     xlab = "time (Years)")
```


## what is the median survival time
```{r}
fit.KM
```

## comparing three groups D-penicillmain, placebo and not randomised
## The log rank test
```{r}
fit.logrank <- survdiff(Surv(time, newStatus) ~ group, data = dat)
fit.logrank
```

## the p-value is not significant therefore we don't reject the null hypothesis. the groups are not different from each other. 


```{r}
fit.KM <- survfit(Surv(timeYears, newStatus) ~ group, data = dat, conf.type = "log-log")
fit.KM
plot(fit.KM, col = 1:3)
```
## Logrank test stratifying by sex
```{r}
survdiff(Surv(time, newStatus) ~ group + strata(sex), data = dat)
```

## Logrank test stratifying by holistic stage of disease
```{r}
survdiff(Surv(time, newStatus) ~ group + strata(stage), data = dat)
```


## Logrank test startifying by edema
```{r}
survdiff(Surv(time, newStatus) ~ group + strata(edema), data = dat)
```

## Logrank test sytratifying by hepato
```{r}
survdiff(Surv(time, newStatus) ~ group + strata(hepato), data = dat)
```



## cox regression ==> exp(beta) refers to unit increase of the regressor. exp(beta) is the hazard ratio . from exp(coef) the not-randomised group has a higher risk, therefore shorter life span. placebo has a lower risk hence longer life span. From both p-values it's clear that the 3 sets of groups are not statistically different from each other. 
```{r}
fit.cph <- coxph(Surv(time, newStatus) ~ group, data = dat)
summary(fit.cph)
```


## running cox regression on a continuous covariate. From the p-value it is clear that age is a statistically significatnt covariate in how the patients respond to the various treatment methods. The HR is 1.04 which implies that as a patient grows older by 1 year the risk of death increases by 4 percent. the scale of the covariate is age in years. +ve coeffient ==> beta the higher the age the higher the risk of dying
```{r}
fit.cph1 <- coxph(Surv(time, newStatus) ~ age, data = dat)
summary(fit.cph1)
```


## Automatic model selection based on AIC
```{r}
Mfull <- coxph(Surv(timeYears, newStatus) ~ age + sex + ascites + hepato + spiders + stage +
                 albumin + group + copper + alk.phos + ast + trig + platelet + bili + chol + 
                 edema + protime, data = dat)
```



```{r}
MAIC <- step(Mfull)
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

